image: alpine:latest

variables:
  HTTP_PROXY: ${HTTP_PROXY}
  HTTPS_PROXY: ${HTTPS_PROXY}
  NO_PROXY: ${NO_PROXY}

stages:
  - docker_image
  - publish_to_test
  - production

docker_image:
  image: $CI_TOOLS_IMAGE
  stage: docker_image
  variables:
    DOCKER_DRIVER: overlay2
  services:
    - name: $CI_PROD_REGISTRY/ci/dind:1.0.0
  script:
    - setup_docker
    - build
  only:
    - branches
  except:
    refs:
      - master
      - tags

docker_prod_image:
  image: $CI_TOOLS_IMAGE
  stage: docker_image
  variables:
    DOCKER_DRIVER: overlay2
  services:
    - name: $CI_PROD_REGISTRY/ci/dind:1.0.0
  script:
    - setup_docker
    - build ${CI_PROD_REGISTRY}
  only:
    - master
  except:
    refs:
      - tags

publish_chart_to_test_repo:
  stage: publish_to_test
  image: $CI_TOOLS_IMAGE
  script:
    - publish_chart tst
  only:
    refs:
      - branches
  except:
    refs:
      - tags
    variables:
      - $DISABLED_PUBLISH

publish_chart_to_prod_repo:
  stage: production
  image: $CI_TOOLS_IMAGE
  script:
    - publish_chart prd
  only:
    refs:
      - master
  except:
      variables:
        - $DISABLED_PUBLISH

# ---------------------------------------------------------------------------

.auto_devops: &auto_devops |
  [[ "$TRACE" ]] && set -x
  [[ "$DEBUG_SLEEP" ]] && sleep $DEBUG_SLEEP
  source /ci-utils.sh || true

before_script:
  - *auto_devops
